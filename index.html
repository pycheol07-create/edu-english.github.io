<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 영어 회화 패턴</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .english-text {
            font-family: 'Inter', sans-serif;
        }
        /* 로딩 스피너 스타일 */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* TTS 재생 중 애니메이션 */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .tts-btn.is-playing svg {
            color: #3b82f6; /* Tailwind blue-500 */
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-3xl mx-auto p-4 md:p-8 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 english-text">🇺🇸 오늘의 영어 회화 패턴 🇺🇸</h1>
            <p id="current-date" class="text-gray-500 mt-2"></p>
        </header>

        <main id="pattern-container" class="space-y-6">
            <!-- 영어 패턴 카드가 여기에 동적으로 추가됩니다. -->
        </main>

        <footer class="text-center mt-8">
            <div class="flex justify-center items-center space-x-4">
                <button id="new-pattern-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg text-lg">
                    새로운 패턴 보기
                </button>
                <button id="all-patterns-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg text-lg">
                    전체 패턴 보기
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-4">매일 자정이 지나면 새로운 패턴이 자동으로 표시됩니다.</p>
            <p class="text-xs text-gray-400 mt-1">v.2025.10.17-7-en</p>
        </footer>
    </div>

    <!-- "이렇게 말하고 싶어요!" 플로팅 버튼 -->
    <button id="open-translator-btn" class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full w-16 h-16 flex items-center justify-center shadow-xl transition-transform transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C13.18 7.061 14.287 7.5 15.5 7.5c1.213 0 2.32-.439 3.166-1.136m0 0V3m-3.166 2.864L18 2.25m-6 12C9.82 14.061 8.713 14.5 7.5 14.5c-1.213 0-2.32-.439-3.166-1.136m0 0V18m3.166-2.864L6 18.75" />
        </svg>
    </button>
    
    <!-- 번역기 팝업 (모달) -->
    <div id="translator-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">이렇게 말하고 싶어요!</h2>
                    <button id="close-translator-btn" class="p-1 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <p class="text-gray-600 mb-4">자연스러운 원어민 표현이 궁금한 한국어 문장을 입력해보세요.</p>
                <textarea id="korean-input" class="w-full p-2 border border-gray-300 rounded-md h-24" placeholder="예) 밥 먹을 기분이 아니야"></textarea>
                <button id="translate-btn" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">원어민 표현 찾아보기</button>
            </div>
            <div id="translation-result" class="mt-4 p-4 bg-gray-50 rounded-md min-h-[100px] overflow-y-auto">
                 <p class="text-gray-400 text-center">결과가 여기에 표시됩니다.</p>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center">
            <p id="custom-alert-message" class="text-gray-700 mb-4"></p>
            <button id="custom-alert-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">확인</button>
        </div>
    </div>

    <!-- 전체 패턴 목록 팝업 (모달) -->
    <div id="all-patterns-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 relative flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">전체 패턴 목록</h2>
                    <button id="close-all-patterns-btn" class="p-1 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <p class="text-gray-600 mb-4">학습하고 싶은 패턴을 선택하세요.</p>
            </div>
            <div id="all-patterns-list" class="mt-2 overflow-y-auto divide-y">
                <!-- 전체 패턴 목록이 여기에 동적으로 추가됩니다. -->
            </div>
        </div>
    </div>

    <script>
        const patternContainer = document.getElementById('pattern-container');
        const currentDateEl = document.getElementById('current-date');
        const newPatternBtn = document.getElementById('new-pattern-btn');

        // --- 번역기 모달 관련 요소 ---
        const openTranslatorBtn = document.getElementById('open-translator-btn');
        const translatorModal = document.getElementById('translator-modal');
        const closeTranslatorBtn = document.getElementById('close-translator-btn');
        const translateBtn = document.getElementById('translate-btn');
        const koreanInput = document.getElementById('korean-input');
        const translationResult = document.getElementById('translation-result');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertCloseBtn = document.getElementById('custom-alert-close-btn');

        // --- 전체 패턴 모달 관련 요소 ---
        const allPatternsBtn = document.getElementById('all-patterns-btn');
        const allPatternsModal = document.getElementById('all-patterns-modal');
        const closeAllPatternsBtn = document.getElementById('close-all-patterns-btn');
        const allPatternsList = document.getElementById('all-patterns-list');

        const allPatterns = [
            {"pattern":"not only A but also B","meaning":"A뿐만 아니라 B도","structure":"not only + 명사/구, but also + 명사/구","examples":[{"english":"She is not only smart but also kind.","korean":"그녀는 똑똑할 뿐만 아니라 친절하기도 해요."},{"english":"He plays not only the guitar but also the piano.","korean":"그는 기타뿐만 아니라 피아노도 연주해요."}],"vocab":[{"word":"smart","meaning":"똑똑한"},{"word":"kind","meaning":"친절한"},{"word":"guitar","meaning":"기타"},{"word":"piano","meaning":"피아노"}], "practice": {"korean": "이 레스토랑은 음식뿐만 아니라 분위기도 훌륭해.", "english": "This restaurant has not only great food but also a great atmosphere."}, "practiceVocab": [{"word":"restaurant","meaning":"레스토랑"},{"word":"atmosphere","meaning":"분위기"}]},
            {"pattern":"as soon as","meaning":"~하자마자","structure":"as soon as + 주어 + 동사","examples":[{"english":"I'll call you as soon as I get home.","korean":"집에 도착하자마자 전화할게."},{"english":"As soon as she finished her work, she left the office.","korean":"그녀는 일을 끝내자마자 사무실을 나갔다."}],"vocab":[{"word":"get home","meaning":"집에 도착하다"},{"word":"finish","meaning":"끝내다"},{"word":"leave","meaning":"떠나다"}], "practice": {"korean": "그 소식을 듣자마자, 나는 그에게 달려갔어.", "english": "As soon as I heard the news, I ran to him."}, "practiceVocab": [{"word":"hear","meaning":"듣다"},{"word":"news","meaning":"소식"},{"word":"run","meaning":"달리다"}]},
            {"pattern":"be supposed to","meaning":"~하기로 되어 있다, ~해야 한다","structure":"be supposed to + 동사원형","examples":[{"english":"You are supposed to finish this report by Friday.","korean":"당신은 이 보고서를 금요일까지 끝내기로 되어 있어요."},{"english":"What am I supposed to do now?","korean":"제가 이제 뭘 해야 하나요?"}],"vocab":[{"word":"report","meaning":"보고서"},{"word":"by Friday","meaning":"금요일까지"}], "practice": {"korean": "우리는 3시에 회의를 하기로 되어 있었어.", "english": "We were supposed to have a meeting at 3 o'clock."}, "practiceVocab": [{"word":"have a meeting","meaning":"회의를 하다"}]},
            {"pattern":"feel like ~ing","meaning":"~하고 싶은 기분이다","structure":"feel like + 동명사","examples":[{"english":"I feel like watching a movie tonight.","korean":"오늘 밤 영화 보고 싶은 기분이야."},{"english":"She didn't feel like going out.","korean":"그녀는 외출하고 싶지 않았다."}],"vocab":[{"word":"watch a movie","meaning":"영화를 보다"},{"word":"go out","meaning":"외출하다"}], "practice": {"korean": "나는 지금 아무것도 하고 싶지 않아.", "english": "I don't feel like doing anything right now."}, "practiceVocab": [{"word":"anything","meaning":"아무것도"},{"word":"right now","meaning":"지금 당장"}]},
            {"pattern":"used to","meaning":"~하곤 했다 (과거의 습관)","structure":"used to + 동사원형","examples":[{"english":"I used to live in this neighborhood.","korean":"나는 이 동네에 살았었다."},{"english":"He used to play basketball a lot when he was young.","korean":"그는 어렸을 때 농구를 많이 하곤 했다."}],"vocab":[{"word":"live","meaning":"살다"},{"word":"neighborhood","meaning":"동네, 이웃"},{"word":"a lot","meaning":"많이"}], "practice": {"korean": "우리는 주말마다 함께 하이킹을 가곤 했어.", "english": "We used to go hiking together every weekend."}, "practiceVocab": [{"word":"go hiking","meaning":"하이킹 가다"},{"word":"together","meaning":"함께"},{"word":"every weekend","meaning":"주말마다"}]},
            {"pattern":"It's no use ~ing","meaning":"~해봐야 소용없다","structure":"It's no use + 동명사","examples":[{"english":"It's no use crying over spilt milk.","korean":"엎질러진 우유 앞에서 울어봐야 소용없다 (속담)."},{"english":"It's no use trying to convince him. He won't change his mind.","korean":"그를 설득하려고 해봐야 소용없어. 그는 마음을 바꾸지 않을 거야."}],"vocab":[{"word":"cry over","meaning":"~에 대해 울다"},{"word":"convince","meaning":"설득하다"},{"word":"change one's mind","meaning":"마음을 바꾸다"}], "practice": {"korean": "지금 와서 후회해봐야 소용없어.", "english": "It's no use regretting it now."}, "practiceVocab": [{"word":"regret","meaning":"후회하다"}]},
            {"pattern":"can't help ~ing","meaning":"~하지 않을 수 없다","structure":"can't help + 동명사","examples":[{"english":"I couldn't help laughing when I saw his face.","korean":"그의 얼굴을 봤을 때 웃지 않을 수 없었다."},{"english":"She can't help worrying about her son.","korean":"그녀는 아들 걱정을 하지 않을 수 없다."}],"vocab":[{"word":"laugh","meaning":"웃다"},{"word":"worry about","meaning":"~에 대해 걱정하다"}], "practice": {"korean": "나는 그 영화를 보고 감동받지 않을 수 없었어.", "english": "I couldn't help being moved by the movie."}, "practiceVocab": [{"word":"be moved","meaning":"감동받다"}]},
            {"pattern":"look forward to ~ing","meaning":"~하기를 고대하다","structure":"look forward to + (동)명사","examples":[{"english":"I'm looking forward to seeing you again.","korean":"다시 뵙기를 고대하고 있습니다."},{"english":"We are looking forward to our vacation.","korean":"우리는 휴가를 고대하고 있어요."}],"vocab":[{"word":"see you again","meaning":"다시 만나다"},{"word":"vacation","meaning":"휴가"}], "practice": {"korean": "저는 당신의 답변을 받기를 고대하겠습니다.", "english": "I look forward to hearing from you."}, "practiceVocab": [{"word":"hear from","meaning":"~로부터 소식을 듣다"}]},
            {"pattern":"It takes (time) to","meaning":"~하는 데 (시간)이 걸리다","structure":"It takes + 시간 + to + 동사원형","examples":[{"english":"It takes about an hour to get there.","korean":"거기까지 가는 데 약 한 시간이 걸려요."},{"english":"How long does it take to learn a new language?","korean":"새로운 언어를 배우는 데 얼마나 걸리나요?"}],"vocab":[{"word":"about an hour","meaning":"약 한 시간"},{"word":"get there","meaning":"거기에 도착하다"},{"word":"learn","meaning":"배우다"}], "practice": {"korean": "이 문제를 해결하는 데 시간이 좀 걸릴 거야.", "english": "It will take some time to solve this problem."}, "practiceVocab": [{"word":"some time","meaning":"시간이 좀"},{"word":"solve","meaning":"해결하다"},{"word":"problem","meaning":"문제"}]},
            {"pattern":"be likely to","meaning":"~할 것 같다, ~할 가능성이 높다","structure":"be likely to + 동사원형","examples":[{"english":"It's likely to rain this afternoon.","korean":"오늘 오후에 비가 올 것 같아요."},{"english":"He is likely to win the election.","korean":"그는 선거에서 이길 가능성이 높다."}],"vocab":[{"word":"rain","meaning":"비가 오다"},{"word":"win","meaning":"이기다"},{"word":"election","meaning":"선거"}], "practice": {"korean": "그들은 제 시간에 도착할 것 같지 않아.", "english": "They are not likely to arrive on time."}, "practiceVocab": [{"word":"arrive","meaning":"도착하다"},{"word":"on time","meaning":"제 시간에"}]},
            {"pattern":"had better","meaning":"~하는 편이 낫다 (충고)","structure":"had better + 동사원형","examples":[{"english":"You had better see a doctor.","korean":"너는 의사에게 진찰을 받는 편이 낫겠다."},{"english":"We'd better hurry, or we'll miss the train.","korean":"서두르는 게 좋겠어, 그렇지 않으면 기차를 놓칠 거야."}],"vocab":[{"word":"see a doctor","meaning":"진찰받다"},{"word":"hurry","meaning":"서두르다"},{"word":"miss the train","meaning":"기차를 놓치다"}], "practice": {"korean": "너는 그에게 사실을 말하는 편이 낫겠어.", "english": "You had better tell him the truth."}, "practiceVocab": [{"word":"tell","meaning":"말하다"},{"word":"truth","meaning":"사실, 진실"}]},
            {"pattern":"prefer A to B","meaning":"B보다 A를 더 선호하다","structure":"prefer + 명사 A + to + 명사 B","examples":[{"english":"I prefer coffee to tea.","korean":"저는 차보다 커피를 더 선호해요."},{"english":"She prefers reading books to watching TV.","korean":"그녀는 TV 보는 것보다 책 읽는 것을 더 선호한다."}],"vocab":[{"word":"prefer","meaning":"선호하다"},{"word":"coffee","meaning":"커피"},{"word":"tea","meaning":"차"}], "practice": {"korean": "나는 여름보다 겨울을 더 좋아해.", "english": "I prefer winter to summer."}, "practiceVocab": [{"word":"winter","meaning":"겨울"},{"word":"summer","meaning":"여름"}]},
            {"pattern":"be about to","meaning":"막 ~하려던 참이다","structure":"be about to + 동사원형","examples":[{"english":"I was about to call you.","korean":"막 너에게 전화하려던 참이었어."},{"english":"The show is about to start.","korean":"쇼가 곧 시작될 겁니다."}],"vocab":[{"word":"call","meaning":"전화하다"},{"word":"show","meaning":"쇼"},{"word":"start","meaning":"시작하다"}], "practice": {"korean": "우리가 막 집을 떠나려던 참에 비가 오기 시작했어.", "english": "We were about to leave the house when it started to rain."}, "practiceVocab": [{"word":"leave the house","meaning":"집을 떠나다"},{"word":"when","meaning":"~할 때"}]},
            {"pattern":"end up ~ing","meaning":"결국 ~하게 되다","structure":"end up + 동명사 / 전치사구","examples":[{"english":"We ended up watching a movie at home instead of going out.","korean":"우리는 외출하는 대신 결국 집에서 영화를 보게 되었다."},{"english":"If you keep spending money like that, you'll end up broke.","korean":"계속 그런 식으로 돈을 쓰면, 너는 결국 파산하게 될 거야."}],"vocab":[{"word":"instead of","meaning":"~대신에"},{"word":"spend money","meaning":"돈을 쓰다"},{"word":"broke","meaning":"파산한"}], "practice": {"korean": "나는 길을 잃었고 결국 이상한 곳에 가게 되었어.", "english": "I got lost and ended up in a strange place."}, "practiceVocab": [{"word":"get lost","meaning":"길을 잃다"},{"word":"strange place","meaning":"이상한 곳"}]},
            {"pattern":"make sense","meaning":"말이 되다, 이치에 맞다","structure":"make sense","examples":[{"english":"What you're saying doesn't make any sense.","korean":"네가 하는 말은 전혀 이치에 맞지 않아."},{"english":"It makes sense to save money for the future.","korean":"미래를 위해 돈을 저축하는 것은 이치에 맞다."}],"vocab":[{"word":"make sense","meaning":"이치에 맞다"},{"word":"save money","meaning":"돈을 저축하다"},{"word":"future","meaning":"미래"}], "practice": {"korean": "아, 이제야 이해가 되네.", "english": "Oh, now it makes sense."}, "practiceVocab": [{"word":"now","meaning":"이제"}]},
            {"pattern":"be worth ~ing","meaning":"~할 가치가 있다","structure":"be worth + (동)명사","examples":[{"english":"This book is worth reading.","korean":"이 책은 읽을 가치가 있다."},{"english":"The view from the top is worth the climb.","korean":"정상에서 보는 경치는 올라갈 만한 가치가 있다."}],"vocab":[{"word":"worth","meaning":"~의 가치가 있는"},{"word":"reading","meaning":"읽기"},{"word":"view","meaning":"경치"},{"word":"climb","meaning":"등반"}], "practice": {"korean": "그 박물관은 방문할 가치가 있어.", "english": "That museum is worth visiting."}, "practiceVocab": [{"word":"museum","meaning":"박물관"},{"word":"visit","meaning":"방문하다"}]},
            {"pattern":"no matter what","meaning":"무엇이든 간에, 무슨 일이 있어도","structure":"no matter what, 주어 + 동사","examples":[{"english":"No matter what happens, I'll always be on your side.","korean":"무슨 일이 일어나든, 나는 항상 네 편일 거야."},{"english":"She is determined to succeed, no matter what.","korean":"그녀는 무엇이든 간에 성공하기로 결심했다."}],"vocab":[{"word":"no matter","meaning":"~에 상관없이"},{"word":"happen","meaning":"일어나다"},{"word":"be on one's side","meaning":"~의 편이다"},{"word":"determined","meaning":"결심이 굳은"}], "practice": {"korean": "무슨 일이 있어도 너는 너의 꿈을 포기해서는 안 돼.", "english": "You should not give up on your dreams, no matter what."}, "practiceVocab": [{"word":"give up on","meaning":"~을 포기하다"},{"word":"dream","meaning":"꿈"}]}
        ];

        let learningCounts = {};
        // --- TTS (Text-to-Speech) 관련 변수 ---
        const audioCache = {};
        let currentAudio = null;
        let currentPlayingButton = null;

        function initializeCounts() {
            const storedCounts = localStorage.getItem('englishLearningCounts');
            if (storedCounts) {
                learningCounts = JSON.parse(storedCounts);
            } else {
                learningCounts = {};
            }
        }

        function saveCounts() {
            localStorage.setItem('englishLearningCounts', JSON.stringify(learningCounts));
        }

        function getTodayString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function displayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const date = today.getDate();
            currentDateEl.textContent = `${year}년 ${month}월 ${date}일`;
        }

        function getRandomPatterns() {
            const shuffled = [...allPatterns].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 2);
        }

       function renderPatterns(patterns, showIndex = false) {
            patternContainer.innerHTML = '';
            patterns.forEach((p, index) => {
                const count = learningCounts[p.pattern] || 0;
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300';
                
                let examplesHtml = p.examples.map(ex => `
                    <div class="mt-3">
                        <div class="flex items-center">
                            <p class="text-lg english-text text-gray-800">${ex.english}</p>
                            <button class="tts-btn ml-2 p-1 rounded-full hover:bg-gray-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 pointer-events-none">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                                </svg>
                            </button>
                        </div>
                        <p class="text-md text-gray-600">${ex.korean}</p>
                    </div>
                `).join('');

                let vocabHtml = p.vocab.map(v => `
                    <div class="flex items-baseline">
                        <p class="w-1/2 text-md english-text text-gray-700 font-medium">${v.word}</p>
                        <p class="w-1/2 text-sm text-gray-600">${v.meaning}</p>
                    </div>
                `).join('');

                const indexHtml = showIndex ? `<span class="bg-blue-100 text-blue-800 text-sm font-semibold mr-3 px-3 py-1 rounded-full">${index + 1}</span>` : '';
                
                let practiceHtml = '';
                if (p.practice) {
                    practiceHtml = `
                        <div class="mt-6">
                            <h3 class="text-lg font-bold text-gray-700 border-b pb-1">✍️ 직접 말해보기</h3>
                            <div class="mt-3 bg-sky-50 p-4 rounded-lg relative">
                                <button id="show-hint-btn-${index}" data-pattern-string="${p.pattern}" data-hint-target="practice-hint-${index}" class="show-hint-btn absolute top-4 right-4 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-1 px-2 rounded-lg text-xs whitespace-nowrap">힌트 보기</button>
                                <p class="text-md text-gray-700 mb-2">다음 문장을 영어로 입력해보세요:</p>
                                <p class="text-md font-semibold text-sky-800 mb-3">"${p.practice.korean}"</p>
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="practice-input-${index}" class="w-full p-2 border border-gray-300 rounded-md english-text" placeholder="영어를 입력하세요...">
                                    <button id="check-practice-btn-${index}" data-answer="${p.practice.english}" data-input-id="practice-input-${index}" class="check-practice-btn bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg whitespace-nowrap">정답 확인</button>
                                </div>
                                <div id="practice-hint-${index}" class="mt-3"></div>
                                <div id="practice-result-${index}" class="mt-3 text-center"></div>
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                             ${indexHtml}
                            <div>
                               <h2 class="text-2xl font-bold text-gray-800 english-text">${p.pattern}</h2>
                            </div>
                        </div>
                        <div class="text-right">
                               <button data-pattern="${p.pattern}" class="learn-btn bg-yellow-400 hover:bg-yellow-500 text-white text-sm font-bold py-1 px-3 rounded-full transition-colors">학습 완료!</button>
                               <p class="text-xs text-gray-500 mt-1">학습 <span class="font-bold text-red-500 count-display">${count}</span>회</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-lg text-blue-700 font-semibold mb-2">${p.meaning}</p>
                        <p class="text-sm text-gray-500 bg-gray-100 p-2 rounded-md"><b>🤔 어떻게 사용할까요?</b> ${p.structure || '구조 정보 없음'}</p>
                    </div>
                    
                    <div class="mt-4">
                        <h3 class="text-lg font-bold text-gray-700 border-b pb-1">💡 예문 살펴보기</h3>
                        ${examplesHtml}
                    </div>

                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-700 border-b pb-1">📌 주요 단어</h3>
                        <div class="mt-3 space-y-2">
                           ${vocabHtml}
                        </div>
                    </div>
                    ${practiceHtml}
                `;
                patternContainer.appendChild(card);
            });
        }
        
        function loadDailyPatterns() {
            const todayStr = getTodayString();
            const storedData = JSON.parse(localStorage.getItem('dailyEnglishPatterns'));

            if (storedData && storedData.date === todayStr) {
                renderPatterns(storedData.patterns);
            } else {
                const newPatterns = getRandomPatterns();
                localStorage.setItem('dailyEnglishPatterns', JSON.stringify({ date: todayStr, patterns: newPatterns }));
                renderPatterns(newPatterns);
            }
        }
        
        // --- 전체 패턴 목록 렌더링 함수 ---
        function renderAllPatternsList() {
            allPatternsList.innerHTML = '';
            allPatterns.forEach((p, index) => {
                const patternItem = document.createElement('div');
                patternItem.className = 'p-4 hover:bg-gray-100 cursor-pointer';
                patternItem.dataset.patternIndex = index;
                patternItem.innerHTML = `
                    <div class="flex items-start pointer-events-none">
                        <span class="mr-3 text-gray-500 font-medium w-8 text-right">${index + 1}.</span>
                        <div>
                            <p class="text-lg font-semibold english-text text-gray-800">${p.pattern}</p>
                            <p class="text-sm text-gray-600">${p.meaning}</p>
                        </div>
                    </div>
                `;
                allPatternsList.appendChild(patternItem);
            });
        }

        
        // --- 이벤트 리스너 ---

        newPatternBtn.addEventListener('click', () => {
             const newPatterns = getRandomPatterns();
             localStorage.setItem('dailyEnglishPatterns', JSON.stringify({ date: getTodayString(), patterns: newPatterns }));
             renderPatterns(newPatterns);
             window.scrollTo(0, 0);
        });

        patternContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('learn-btn')) {
                const pattern = e.target.dataset.pattern;
                learningCounts[pattern] = (learningCounts[pattern] || 0) + 1;
                saveCounts();
                e.target.nextElementSibling.querySelector('.count-display').textContent = learningCounts[pattern];
            } else if (e.target.classList.contains('check-practice-btn')) {
                const button = e.target;
                const inputId = button.dataset.inputId;
                const index = inputId.split('-').pop();
                
                const correctAnswer = button.dataset.answer;
                const userInput = document.getElementById(inputId).value.trim();
                const resultDiv = document.getElementById(`practice-result-${index}`);
                
                const normalize = (str) => str.replace(/[.,'’"?!]/g, '').replace(/\s+/g, ' ').toLowerCase();

                let resultMessageHtml = '';
                
                const answerHtml = `
                    <div class="mt-2 p-2 bg-gray-100 rounded text-left">
                        <p class="text-sm">정답:</p>
                        <div class="flex items-center">
                            <p class="text-md english-text font-semibold text-gray-800">${correctAnswer}</p>
                            <button class="tts-btn ml-2 p-1 rounded-full hover:bg-gray-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 pointer-events-none">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;

                if (normalize(userInput) === normalize(correctAnswer)) {
                    resultMessageHtml = `<p class="text-green-600 font-bold text-lg">🎉 정답입니다!</p>` + answerHtml;
                } else {
                    resultMessageHtml = `
                        <p class="text-red-500 font-bold text-lg">🤔 아쉽네요, 다시 시도해보세요.</p>
                        ${answerHtml}
                    `;
                }

                resultDiv.innerHTML = `
                    ${resultMessageHtml}
                    <button class="retry-practice-btn mt-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" data-practice-index="${index}">
                        다시하기
                    </button>
                `;
                
                button.style.display = 'none';
                document.getElementById(`show-hint-btn-${index}`).style.display = 'none';

            } else if (e.target.classList.contains('show-hint-btn')) {
                const button = e.target;
                const patternString = button.dataset.patternString;
                const hintTargetId = button.dataset.hintTarget;
                const hintDiv = document.getElementById(hintTargetId);

                const patternData = allPatterns.find(p => p.pattern === patternString);

                if (patternData && patternData.practiceVocab && patternData.practiceVocab.length > 0) {
                    const shuffledVocab = [...patternData.practiceVocab].sort(() => 0.5 - Math.random());
                    
                    const hintsHtml = shuffledVocab.map(hint => `
                        <div class="flex items-baseline" style="line-height: 1.3;">
                            <span class="inline-block w-[50%] font-medium english-text pr-2">${hint.word}</span>
                            <span class="inline-block w-[50%] text-sm text-gray-600">${hint.meaning}</span>
                        </div>
                    `).join('');

                    hintDiv.innerHTML = `
                    <div class="bg-white/50 rounded-md p-2 text-left">
                        <div class="flex items-center mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-0.5 text-yellow-500">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.25 21.75l-.648-1.178a2.625 2.625 0 00-1.933-1.933L12.5 18l1.178-.648a2.625 2.625 0 001.933-1.933L16.25 14.25l.648 1.178a2.625 2.625 0 001.933 1.933L20 18l-1.178.648a2.625 2.625 0 00-1.933 1.933z" />
                            </svg>
                            <span class="font-semibold text-sm text-gray-700">힌트</span>
                        </div>
                        <div class="border-t border-gray-300/50 pt-1">${hintsHtml}</div>
                    </div>`;
                    
                } else {
                    hintDiv.innerHTML = `<p class="text-sm text-gray-500">이 문장에 대한 핵심 단어 정보가 없습니다.</p>`;
                }
                
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            } else if (e.target.classList.contains('retry-practice-btn')) {
                const index = e.target.dataset.practiceIndex;

                document.getElementById(`practice-input-${index}`).value = '';
                document.getElementById(`practice-result-${index}`).innerHTML = '';
                document.getElementById(`practice-hint-${index}`).innerHTML = '';

                document.getElementById(`check-practice-btn-${index}`).style.display = '';
                const hintBtn = document.getElementById(`show-hint-btn-${index}`);
                hintBtn.style.display = '';
                hintBtn.disabled = false;
                hintBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
        
        // '직접 말해보기' 입력창에서 Enter 키로 정답 확인 기능 추가
        patternContainer.addEventListener('keydown', (e) => {
            if (e.target.id.startsWith('practice-input-') && e.key === 'Enter') {
                e.preventDefault(); 
                const checkButton = e.target.nextElementSibling;
                if (checkButton && checkButton.classList.contains('check-practice-btn')) {
                    checkButton.click();
                }
            }
        });
        
        openTranslatorBtn.addEventListener('click', () => translatorModal.classList.remove('hidden'));
        closeTranslatorBtn.addEventListener('click', () => {
            translatorModal.classList.add('hidden');
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        });

        // '전체 패턴 보기' 모달 이벤트
        allPatternsBtn.addEventListener('click', () => {
            allPatternsModal.classList.remove('hidden');
        });

        closeAllPatternsBtn.addEventListener('click', () => {
            allPatternsModal.classList.add('hidden');
        });

        allPatternsList.addEventListener('click', (e) => {
            const selectedPatternDiv = e.target.closest('[data-pattern-index]');
            if (selectedPatternDiv) {
                const patternIndex = parseInt(selectedPatternDiv.dataset.patternIndex, 10);
                const selectedPattern = allPatterns[patternIndex];
                if (selectedPattern) {
                    renderPatterns([selectedPattern]);
                    allPatternsModal.classList.add('hidden');
                    window.scrollTo(0, 0);
                }
            }
        });

        translateBtn.addEventListener('click', async () => {
            const koreanText = koreanInput.value.trim();
            if (!koreanText) {
                showAlert('번역할 한국어 문장을 입력해주세요.');
                return;
            }

            translationResult.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const resultText = await getNativeTranslation(koreanText);
                const lines = resultText.split('\n').filter(line => line.trim() !== '');

                const englishText = lines.find(line => !line.startsWith('#')) || '번역 결과를 찾을 수 없습니다.';
                const explanationText = lines.slice(lines.findIndex(line => line.startsWith('####'))).join('<br>') || '설명을 찾을 수 없습니다.';

                translationResult.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mt-2">자연스러운 표현</h3>
                    <div class="flex items-center">
                        <p class="text-lg english-text text-gray-800">${englishText.replace('### 자연스러운 표현', '').trim()}</p>
                        <button class="tts-btn ml-2 p-1 rounded-full hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 pointer-events-none">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                        </button>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-2">💡 이렇게 표현하는 이유</h4>
                    <p>${explanationText.replace('#### 💡 이렇게 표현하는 이유', '').trim()}</p>
                `;

            } catch (error) {
                console.error('Translation error:', error);
                showAlert(`번역 중 오류가 발생했습니다. 서버 응답: ${error.message}`);
            }
        });

        function showAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        }
        
        customAlertCloseBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });

        // --- TTS (Text-to-Speech) 관련 함수 ---

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmDataView, sampleRate) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmDataView.byteLength;

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            // "fmt " sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size for PCM
            view.setUint16(20, 1, true); // AudioFormat for PCM
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // BitsPerSample
            // "data" sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            
            return new Blob([view.buffer, pcmDataView.buffer], { type: 'audio/wav' });
        }
        
        async function playAudio(text, buttonEl) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            document.querySelectorAll('.tts-btn.is-playing').forEach(btn => btn.classList.remove('is-playing'));

            if (currentPlayingButton === buttonEl) {
                currentPlayingButton = null;
                currentAudio = null;
                return;
            }

            buttonEl.classList.add('is-playing');
            currentPlayingButton = buttonEl;

            const playFromAudioObject = (audioObj) => {
                currentAudio = audioObj;
                currentAudio.currentTime = 0;

                const onEnd = () => {
                    buttonEl.classList.remove('is-playing');
                    currentAudio.removeEventListener('ended', onEnd);
                    if (currentPlayingButton === buttonEl) {
                        currentPlayingButton = null;
                        currentAudio = null;
                    }
                };
                currentAudio.addEventListener('ended', onEnd);
                
                const playPromise = currentAudio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Audio play failed:", error);
                        showAlert(`오디오 재생에 실패했습니다: ${error.message}`);
                        onEnd();
                    });
                }
            };

            if (audioCache[text]) {
                playFromAudioObject(audioCache[text]);
                return;
            }

            try {
                // API 호출 방식을 Vercel 서버리스 함수를 통하도록 수정합니다.
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'tts', // 'tts' 작업을 요청
                        text: text
                    })
                });


                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API call failed: ${response.status} - ${errorText}`);
                }
                const result = await response.json();
                
                const audioContent = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = audioContent?.inlineData?.data;
                const mimeType = audioContent?.inlineData?.mimeType;

                if (audioData && mimeType) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(new DataView(pcmData), sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const newAudio = new Audio(audioUrl);
                    
                    newAudio.onerror = function() {
                        console.error("Audio format error.");
                        showAlert("오디오 파일 형식 오류가 발생했습니다.");
                        buttonEl.classList.remove('is-playing');
                        if (currentPlayingButton === buttonEl) {
                           currentPlayingButton = null;
                        }
                    };

                    audioCache[text] = newAudio;
                    playFromAudioObject(newAudio);

                } else {
                    throw new Error("API 응답에 오디오 데이터가 없습니다.");
                }
            } catch (error) {
                console.error("TTS Error:", error);
                showAlert(`음성 생성 중 오류가 발생했습니다: ${error.message}`);
                buttonEl.classList.remove('is-playing');
                currentPlayingButton = null;
            }
        }

        document.body.addEventListener('click', (e) => {
            const ttsButton = e.target.closest('.tts-btn');
            if (ttsButton) {
                const textElement = ttsButton.previousElementSibling;
                
                if (textElement && textElement.classList.contains('english-text')) {
                    const text = textElement.textContent.trim();
                    if (text) {
                        playAudio(text, ttsButton);
                    }
                }
            }
        });
        
        async function getNativeTranslation(text) {
            const systemPrompt = `You are an expert in Korean-English translation. Your role is to translate the user's Korean sentence into a natural, colloquial English sentence that a native speaker would use in everyday conversation. Your response must be in Korean and follow this structure exactly:
### 자연스러운 표현
[Provide the most natural English sentence here]
#### 💡 이렇게 표현하는 이유
[Provide a brief and clear explanation in Korean about why this expression is natural and used by native speakers.]`;

            try {
                // API 호출 방식을 Vercel 서버리스 함수를 통하도록 수정합니다.
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'translate', // 'translate' 작업을 요청
                        text: text,
                        systemPrompt: systemPrompt
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API Error:", errorText);
                    throw new Error(`API call failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                
                if (!result.candidates || result.candidates.length === 0 || !result.candidates[0].content?.parts?.[0]?.text) {
                     console.error("Invalid API response structure:", result);
                     throw new Error("API 응답이 비어있거나 형식이 올바르지 않습니다.");
                }
                return result.candidates[0].content.parts[0].text;
            } catch(error) {
                 console.error("Translation function error:", error);
                 throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            displayDate();
            initializeCounts();
            loadDailyPatterns();
            renderAllPatternsList();
        });
    </script>
</body>
</html>









